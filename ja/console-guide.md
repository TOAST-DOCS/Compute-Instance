## Compute > Instance > コンソール使用ガイド

## インスタンス生成

インスタンスを作成するには、以下の設定を行うか、インスタンステンプレート(Instance Template)を利用します。インスタンステンプレートを利用してインスタンスを作成するにはインスタンス作成画面で**インスタンステンプレート使用**を選択します。インスタンステンプレートの作成方法は[インスタンステンプレートコンソールガイド](/Compute/Instance%20Template/ja/console-guide/)を参照します。

### イメージ

希望のオペレーションシステムがインストールされているイメージを選択します。イメージはNHN Cloudが提供するパブリックイメージ、作成済のユーザーイメージ、共有イメージから選択できます。

使用するイメージによってインスタンスタイプ(flavor)が異なるので、インスタンス生成の際は、まず初めにイメージを選択してください。

| オペレーションシステム                  | ブロックストレージ    | メモリ  |
| ---------------------------------------- | ---------- | -------- |
| Linux<br>CentOS、Ubuntu、Debian、Rocky | 20GB以上  | 1GB以上 |
| Windows                           | 50GB以上  | 2GB以上 |


### アベイラビリティゾーン(availability zone)

アベイラビリティゾーンを明示的に設定しない場合、任意の領域が設定されます。アベイラビリティゾーンに応じて、このインスタンスが使用できるブロックストレージが決定されます。使用するブロックストレージが特定アベイラビリティゾーンに存在する場合は、そのアベイラビリティゾーンに設定して使用します。

> [参考] VPCのリソースは全てのアベイラビリティゾーンで使用できます。

アベイラビリティゾーンの詳細については[インスタンス概要のアベイラビリティゾーン](./overview/#availability-zone)を参照してください。

### インスタンスタイプ(flavor)

仮想ハードウェアの性能に応じて様々なインスタンスタイプを選択できます。ただし、イメージが要求する仮想ハードウェアの性能に応じて、選択できるタイプが制限されることがあります。詳細については[インスタンス概要](./overview)を参照してください。

> [参考]
> 1 vCPUはスレッド1つとコア1つで構成されたソケット1つを意味します。ソケット1つあたりのスレッド数とコア数はそれぞれ1個で一定です。

インスタンスタイプはインスタンス生成後にもNHN Cloudコンソールで変更できます。高い仕様から低い仕様に、また低い仕様から高い仕様に変更することもできます。一部のインスタンスタイプは変更できない場合もあるので詳細は[インスタンスタイプ変更](./console-guide/#_14)を参照してください。

> [注意]インスタンスのルートブロックストレージはインスタンスタイプ変更で変えることができません。

### ブロックストレージサイズ

インスタンスのルートブロックストレージを決定します。

- インスタンスが一度生成されると、ルートブロックストレージサイズは変更できません。インスタンスのディスク容量が足りない場合は、ブロックストレージを追加して使用する必要があります。
- ブロックストレージのサイズはイメージが要求する最小サイズ以上にする必要があります。

インスタンスのルートブロックストレージサイズはインスタンスタイプによって異なります。

| 仕様              | サポートするブロックストレージのサイズ             |
| ---------------- | -------------------------------- |
| u2タイプ            | 20 ～ 100 GB (仕様ごとに固定)        |
| t2、m2、c2、r2、x1タイプ   | 20 ～2000GB       　               |

>[参考]ブロックストレージのサイズに応じて課金されるため、基本ブロックストレージサイズを無条件に大きくするのは非効率的です。必要に応じてブロックストレージを追加して使用すると良いでしょう。

### ブロックストレージタイプ

インスタンスの基本ブロックストレージタイプを決定します。

- **HDD**または**SSD**のいずれかを選択します。タイプによって料金と性能が異なります。
- 一度選択したブロックストレージタイプは変更できません。 

### インスタンス数

イメージ、アベイラビリティゾーン、インスタンスタイプ、ブロックストレージサイズ、キーペア、ネットワーク設定が、全て同じインスタンスを複数生成する場合に使用します。インスタンスの名前には、設定した名前の後ろに「-1」、「-2」のような番号が振られます。例えば、インスタンス名を「my-instance」にしてインスタンスを2個生成すると、「my-instance-1」、「my-instance-2」が生成されます。一度に生成できる最大インスタンス数は10個です。

任意のアベイラビリティゾーンにインスタンスを複数生成した場合、それぞれのインスタンスは任意のアベイラビリティゾーンに生成されます。たとえば、2個のインスタンスを任意のアベイラビリティゾーンに生成した場合、2個が同じアベイラビリティゾーンに生成されることもあれば、別のアベイラビリティゾーンに生成されることもあります。全てのインスタンスを同じアベイラビリティゾーンに生成する必要がある時は、特定アベイラビリティゾーンを選択して生成します。

### キーペア

既存のキーペアを使用したり、新たにキーペアを生成して使用します。既存キーペアの登録はWindowsユーザーの場合、[キーペア作成(Windowsユーザー)](./console-guide/#windows_1)、Mac、Linuxユーザーの場合は[キーペア作成(Mac、Linuxユーザー)](./console-guide/#maclinux)を参照してください。

### ネットワーク

VPCで定義されたサブネットの中からインスタンスに接続するサブネットを選択します。サブネットを一つ選択するたびに、インスタンスに該当のサブネットに接続するネットワークインターフェイスが作られます。選択されたサブネットの順序を変えてネットワークインターフェイスを変更することもできます。この場合、最初のネットワークインターフェイス(`eth0`)が基本ゲートウェイに設定されます。

ネットワーク作成と管理の詳細については[VPC概要](/Network/VPC/ja/overview/)を参照してください。

### Floating IP

インスタンス作成後、Floating IPを使用するかどうかを指定します。Floating IP使用を選択すると、Floating IPを新たに作成して最初のネットワークインターフェイスに接続します。この時、最初のネットワークインターフェイスは必ずインターネットゲートウェイが設定されているサブネットに接続されている必要があります。

Floating IP管理は、Instance > 管理ページまたはInstance > Floating IPページで行えます。Floating IPの詳細は、[VPCコンソール使用ガイド](/Network/VPC/ja/console-guide/)を参照してください。

### セキュリティグループ

インスタンスが属すセキュリティグループを指定します。一つのインスタンスは複数のセキュリティグループに属すことがあります。インスタンスが複数のセキュリティグループに属す場合は、次を参照してください。

- 各セキュリティグループに属している全てのインスタンスとネットワーク通信ができます。別のインスタンスの意図していないアクセスを防ぐ必要のある機密データを持つインスタンスの場合は、慎重にセキュリティグループを指定する必要があります。
- 各セキュリティグループの全てのルールが合わさって、該当のインスタンスの外部通信に適用されます。

セキュリティグループの詳細については[VPC概要](/Network/VPC/ja/overview/)を参照してください。

### 追加ブロックストレージ

インスタンス作成後、追加ブロックストレージに接続するかどうかを指定します。追加ブロックストレージ使用を選択すると、ルートブロックストレージとは別の新しいブロックストレージを作成してインスタンスに接続します。ルートブロックストレージ同様、追加ブロックストレージを作成する時に、名前、ストレージタイプ、サイズを指定できます。

ルートブロックストレージはOS用途でのみ使用し、追加ブロックストレージにはよく使用するソフトウェアやデータを保管すると、ブロックストレージ接続/解除またはスナップショット機能で簡単に移行や複製ができます。またインスタンスに障害が発生した時、追加ブロックストレージのみ解除して他のインスタンスに接続することで、簡単にサービスを復旧できます。

ブロックストレージ管理は、Instance > Block Storageページでもできます。ブロックストレージの詳細は[ブロックストレージガイド](/Storage/Block%20Storage/ja/overview/)を参照してください。

### ユーザースクリプト

インスタンス作成後に実行するスクリプトを指定します。ユーザースクリプトは、インスタンスの最初の起動が完了した後、ネットワーク設定などの初期化プロセスが終わった後に実行されます。NHN Cloudのユーザースクリプトは公式イメージに含まれているcloud-init (Linux)、Cloudbase-init (Windows)などの自動化ツールにより実行されます。

> [注意]
> ユーザースクリプトはroot (Linux)/Administrator (Windows)ユーザー権限で実行されます。

#### Linux
ユーザースクリプトの最初の行は必ず`#!`で始まる必要があります。
```
#!/bin/bash
...
```

ユーザースクリプトが正常に動作するには、インスタンス内部のログファイルを確認する必要があります。スクリプトで標準出力/エラー装置に出力したログは`/var/log/cloud-init-output.log`で確認できます。

#### Windows

Windowsイメージではユーザースクリプト形式にBatchスクリプト形式、 Powershellスクリプト形式をすべてサポートします。各形式は最初の行に明示する表示子により区別されます。

* Batchスクリプト
```
rem cmd
...
```

* PowerShellスクリプト
```
#ps1_sysnative
...
```

BatchスクリプトとPowerShellスクリプトを一緒に使用したい場合は、下記のように記述します。

* EC2 format
```
<script>
...
</script>
<powershell>
...
</powershell>
```

ユーザースクリプトのログは、`C:\Program Files\Cloudbase Solutions\Cloudbase-Init\log\cloudbase-init`で確認できます。

ユーザースクリプト関連の詳細は、[cloud-init](https://cloudinit.readthedocs.io/en/latest/topics/format.html)または[Cloudbase-init](https://cloudbase-init.readthedocs.io/en/latest/userdata.html)ガイドを参照してください。

## インスタンス追加機能

### イメージ作成

インスタンスのルートブロックストレージからイメージを作成します。イメージ作成は、データの整合性を保障するために、インスタンスを停止した状態で行うことを推奨します。

インスタンスのルートブロックストレージに空き容量が全くない場合、イメージの作成はできますが、イメージを別のインスタンスで使用するための初期化作業は行えないので正常に使用できません。イメージを作成する前にインスタンスで最低100KBの空き容量を確保する必要があります。

作成されたイメージは**Compute > Image**にプライベートイメージとして登録されます。登録されたイメージを利用して、元のインスタンスと同じブロックストレージを持つインスタンスを作成できます。

### Floating IP接続と解除

インスタンスの状態にかかわらずFloating IPを接続または解除できます。使用できるFloating IPがない場合や、希望するFloating IPがない場合、**生成**ボタンをクリックしてFloating IPを生成して接続できます。また**Network > VPC > Floating IP**でFloating IPを生成して使用することもできます。

Floating IPの詳細については[VPC概要](/Network/VPC/ja/overview/)を参照してください。

### セキュリティグループ修正

インスタンスの状態に関わらずインスタンスのセキュリティグループを修正できます。修正されたセキュリティグループはすぐに適用されます。

セキュリティグループの詳細については[セキュリティグループ](./console-guide/#_8)と[VPC概要](/Network/VPC/ja/overview/)を参照してください。

### サブネット変更

インスタンスのネットワークサブネットはインスタンスが停止した状態でのみ変更できます。サブネットを追加すると、自動的にインスタンスに該当サブネットに接続されるネットワークインターフェイスが作成されます。この時、一度に複数のサブネットを追加するとインスタンスに新たに作成されるネットワークインターフェイスの順序は任意で指定されます。サブネットをインスタンスから削除すると作成されていたネットワークインターフェイスも自動的に削除されます。

### インスタンスタイプ変更

インスタンスの仕様は、インスタンスを停止した後に変更できます。インスタンスが実行中の場合は**追加機能**の**インスタンス停止**をクリックしてインスタンスを停止します。

現在の仕様に応じて、変更できるインスタンスの仕様が異なります。

* m2、c2、r2、t2、x1タイプのインスタンスはm2、c2、r2、t2、x1タイプのインスタンスタイプに変更できます。
* m2、c2、r2、t2、x1タイプのインスタンスはu2タイプのインスタンスタイプに変更できません。
* u2タイプは生成後に仕様を変更できません。同じu2タイプのインスタンスタイプへも変更できません。

インスタンスの仕様を変更すると、変更作業と変更確認作業が行われます。全ての作業が完了するとVM状態が**Shutoff**状態になり、**追加機能**の**Start instance**をクリックしてインスタンスを起動できます。

> [参考]インスタンスのルートブロックストレージサイズは変更できません。インスタンスのブロックストレージ容量が足りない場合は、ブロックストレージを追加して使用します。ブロックストレージ追加方法については[ブロックストレージ概要](/Storage/Block%20Storage/ja/overview/)を参照してください。

インスタンスは変更時点を基準に変更された仕様で課金されます。

## キーペア

### キーペアを作成する(Windowsユーザー)

PuTTY SSHクライアントをインストールすると一緒にインストールされるputtygenプログラムでキーペアを生成し、NHN Cloudに登録して使用できます。

[PuTTY](https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html)をインストールします。

Puttygenを実行します。

![イメージ1](http://static.toastoven.net/prod_instance/putty-ssh-001-en.png)

**パラメータ**で**RSA**(旧バージョンのputtygenではSSH-2 RSA)を選択します。 **Actions**にある**「Generate」**ボタンをクリックします。キーを生成するために空欄の中でマウスを動かします。

キーが生成されたら下図のように公開鍵ファイル内容が表示されます。公開鍵全体を**キーペア作成**の**公開鍵:**入力欄に貼り付けてキーペアを登録します。

![イメージ1](http://static.toastoven.net/prod_instance/putty-ssh-002-en.png)

** Actions **の**「Save private key」**をクリックして秘密鍵を保存します。キーパスフレーズを空欄のまま秘密鍵を保存すると、**キーパスフレーズで保護されないままこのキーを保存しますか？**というメッセージが表示されます。変換された秘密鍵をより安全に使用するには、キーパスフレーズを設定して保存します。

> [注意]
インスタンスに自動的にログインするには、キーパスフレーズを使わないでください。キーパスフレーズを使用するとログインする際に秘密鍵のパスワードを直接入力する必要があります。

登録したキーペアはインスタンスを生成する時に使用でき、インスタンス接続時にはこのキーペアの秘密鍵で接続する必要があります。インスタンス接続方法は[インスタンス概要](./overview/#_5)を参照してください。

NHN Cloudで生成したキーペア同様、このように作成されたキーペアの秘密鍵も外部に流出すると、誰でも流出した秘密鍵でそのインスタンスにアクセスできるようになるので、慎重に管理する必要があります。



### キーペア作成(Mac、Linuxユーザー)

MacやLinuxの「ssh-keygen」で作成したキーペアをNHN Cloudに登録して使用できます。キーペアは次のコマンドで作成します。

	$ ssh-keygen -t rsa -f my_key.key

キーペアのパスワードは設定しても構いませんが、設定しなくても問題はありません。セキュリティレベルを上げるならば、パスワードの設定を推奨します。入力したキーペアの名前に拡張子「.pub」が追加されたファイル内にキーペア公開鍵が入っています。

	$ cat my_key.key.pub
	ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCnnUAe36txQqk8J7VzbNuYKVQQ3gbNoClndHMX49OD+1Rw5xrDFLUKQqxbBDtlNMoA9tKBZNrQBpKr1kFEtvMIj1HPkH9ocb4MbuoVVjpkIhixbKMMJPDQ4JQJxaifsjR59YsZyDAp0aXZp+o+OB97P3S4AKPY2kQR0JdSr30+6Av6smf+3mZceAE4abzklfbyWT5slP1im/wfYEPO3QBEDl/0JbmTjKWPYI6QnbwnPRHS63SJ+Kd2QeYQYJCadv7X4mXnw81qEIWq/dx1SQkGDTNgR7lnN2ApFlU5EZcow69z6tiCr0hlyigwjGooMg3wTZvcSlYcVeTzZ755RArd ...

この内容全体を**キーペア作成**の**公開鍵:**入力欄に貼り付けてキーペアを登録します。

登録したキーペアはインスタンスを生成する時に使用でき、インスタンス接続時にはこのキーペアの秘密鍵で接続する必要があります。インスタンス接続方法は[インスタンス接続方法](./overview/#_5)を参照してください。

NHN Cloudで生成したキーペア同様、このように作成されたキーペアの秘密鍵も外部に流出すると誰でも流出した秘密鍵でそのインスタンスにアクセスできるようになるので慎重に管理する必要があります。

## 付録1. Windows言語パックの変更

NHN CloudのWindowsイメージは、英語版が基本設定になっています。他の言語を基本設定にする方法は次のとおりです。

1. **START > Control Panel > Clock, Language, and Region > Add a language**を選択します。
![イメージ1](http://static.toastoven.net/prod_instance/windows1.png)

2. **言語基本設定変更 > 言語追加**を選択します。
![イメージ1](http://static.toastoven.net/prod_instance/windows2.png)

3. **言語追加(Add a language)**で使用したい言語を選択し、**追加(Add)**をクリックします。
![イメージ1](http://static.toastoven.net/prod_instance/windows3.png)

4. 追加された言語パックを確認します。
![イメージ1](http://static.toastoven.net/prod_instance/windows4.png)

5. 追加された言語パックをダウンロードし、インストールします。
![イメージ1](http://static.toastoven.net/prod_instance/windows5.png)

6. アップデートをダウンロードし、インストールします。
![イメージ1](http://static.toastoven.net/prod_instance/windows6.png)

7. インストールされた言語パックを変更するには、選択した言語をダブルクリックするか、**オプション(Options)**を選択します。
![イメージ1](http://static.toastoven.net/prod_instance/windows7.png)

8. 言語オプションで、**基本言語に設定**を選択します。
![イメージ1](http://static.toastoven.net/prod_instance/windows8.png)

9. 基本言語設定を適用するには、**いまログオフ(Log off now)**をクリックします。
![イメージ1](http://static.toastoven.net/prod_instance/windows9.png)

10. 再度ログインすると、ユーザーが選択した言語パックへの変更を確認できます。
![イメージ1](http://static.toastoven.net/prod_instance/windows10.png)

## 付録2. Windowsルーティングの変更

NHN CloudWindowsでルーティングを変更する方法は次のとおりです。


* **Windowsキー + R**を押すと「ファイル名を指定して実行」ダイアログが表示されるので、名前に`cmd`と入力してOKボタンをクリックし、コマンドプロンプトウィンドウを開きます。


  Routeコマンドを入力します。

* 現在設定の出力：route print
* 追加：route add "宛先" mask "subnet" "gateway" metric "メトリック値" if "インターフェイス番号"
* 変更：route change "宛先" mask "subnet" "gateway" metric "メトリック値" if "インターフェイス番号"
* 削除：route delete "宛先" mask "宛先subnet" "gateway" metric "メトリック値" if "インターフェイス番号"
* オプション：-p (永久ルート指定)


説明


![イメージ1](http://static.toastoven.net/prod_instance/windows_route1.png)

* メトリック値：値が小さいほど優先順位が高い
* インターフェイス番号：route printで確認可能(上の図で赤色の枠)
* 永久ルート：-pオプションを使用しない場合、システム再起動時に、設定したルートが初期化されるため使用(上の図で青色の枠)

事例1 - 特定インターフェイスのみ外部通信設定

* route changeコマンドを使用し、外部通信をしたくないインターフェイスルートのmetricを修正するか、固定IP設定でデフォルトゲートウェイ情報を入力しない方法などがあります。

* Metricの修正方法
    * インターフェイスのmetric増加

            $ route change 0.0.0.0 mask 0.0.0.0 172.16.5.1 metric 10 if 14 -p

![イメージ1](http://static.toastoven.net/prod_instance/windows_route2.png)

* 固定IPの設定方法
    1. ipconfig /allを入力し、IP情報を確認します。
![イメージ1](http://static.toastoven.net/prod_instance/windows_route3.png)
    2. 確認したIP情報を利用し、IP設定ウィンドウでデフォルトゲートウェイを除いて入力します。
![イメージ1](http://static.toastoven.net/prod_instance/windows_route4.png)
    3. route printで確認します。
![イメージ1](http://static.toastoven.net/prod_instance/windows_route5.png)

事例2 - 特定帯域に対するルート設定

* route addコマンドで、特定帯域に対するルートを設定します。

        $ route add 172.16.0.0 mask 255.255.0.0 172.16.5.1 metric 1 if 14 -p

![イメージ1](http://static.toastoven.net/prod_instance/windows_route6.png)


事例3 - 特定ルートの除去

* route deleteを使用し、指定したルートを除去します。

        $ route delete 172.16.0.0 mask 255.255.0.0 172.16.5.1

![イメージ1](http://static.toastoven.net/prod_instance/windows_route7.png)

## 付録3. システムロケールの変更

NHN CloudのWindowsで、システムロケールを変更する方法は次の通りです。

1. **スタート > コントロールパネル > 時計、言語、および地域**を選択します。
![画像1](http://static.toastoven.net/prod_instance/win_locale1.png)

2. **地域と言語**を選択します。
![画像1](http://static.toastoven.net/prod_instance/win_locale2.png)

3. **管理**タブで**システムロケール変更**をクリックします。
![画像1](http://static.toastoven.net/prod_instance/win_locale3.png)

4. 変更するシステムロケールを選択します。
![画像1](http://static.toastoven.net/prod_instance/win_locale4.png)

5. 適用するにはシステムを再起動します。
![画像1](http://static.toastoven.net/prod_instance/win_locale5.png)

## 付録4. ハイパーバイザーのメンテナンスのためのインスタンス再起動ガイド
NHN Cloudは周期的にハイパーバイザーのソフトウェアをアップデートして、基本インフラサービスのセキュリティと安定性を向上させています。
メンテナンス対象のハイパーバイザーで起動中のインスタンスは再起動を行い、メンテナンスが完了したハイパーバイザーに移動する必要があります。

インスタンスを再起動するには、コンソールでインスタンス名の横に作成された**!再起動** ボタンを使用する必要があります。
`コンソールにあるインスタンス再起動またはOSの再起動機能では、インスタンスが別のハイパーバイザに移動しません。`
下記のガイドに従って、コンソールの再起動機能を利用してください。

メンテナンス対象に指定されたインスタンスがあるプロジェクトに移動します。

**1. メンテナンス対象インスタンスを確認します。**

インスタンス名の前に**!再起動**ボタンがあるインスタンスが、メンテナンス対象のインスタンスです。
**再起動**ボタンの上にマウスオーバーすると、詳細なメンテナンス時間を確認できます。
![イメージ1](http://static.toastoven.net/prod_instance/instance_p_migration_jp_1.png)    

**2. メンテナンス対象インスタンスで起動中のアプリケーションを無効化するか、終了します。**

メンテナンス対象インスタンスで起動中のアプリケーションを無効化するか終了して、サービスに影響を与えないようにする必要があります。 
やむを得ずサービスに影響を与えてしまう時は、NHN Cloudサポートに連絡してくだされば、適切な措置を案内いたします。

**3. メンテナンス対象インスタンス名の横に作成された[!再起動]ボタンをクリックします。**

![イメージ2](http://static.toastoven.net/prod_instance/instance_p_migration_jp_2.png)

**4. インスタンスの再起動を確認するウィンドウが表示されたら、[確認] ボタンをクリックします。**

![イメージ3](http://static.toastoven.net/prod_instance/instance_p_migration_jp_3.png)

**5. インスタンス状態表示灯が緑に変わり、[!再起動] ボタンが消えるまで待機します。**

インスタンス状態表示灯が変わらない場合や、**!再起動**ボタンが無効化されない場合は、「更新」を行ってみてください。


インスタンスの再起動中は、該当インスタンスを一切操作できません。
インスタンスの再起動が正常に完了しない場合は、自動的に管理者に報告され、NHN Cloudから別途連絡いたします。
